<!DOCTYPE html>
<html lang="en" data-ep-shell="true">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma Feedback - Intelligence Hub</title>
    <script id="ep-tailwind-preflight-off" data-ep="tailwind-preflight-off">
        window.tailwind = window.tailwind || {};
        tailwind.config = tailwind.config || {};
        tailwind.config.corePlugins = Object.assign({}, tailwind.config.corePlugins || {}, { preflight: false });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Local UI Shell CSS - loaded directly for reliability (no cross-origin dependency) -->
    <link rel="stylesheet" href="ui-shell.css">
    <!-- SSO Auth Controller and Impersonation dynamic load -->
    <script>
        (function () {
            const isProd = window.location.hostname.includes('run.app') || window.location.hostname.includes('emailpilot.ai');
            const orchestratorUrl = isProd ? 'https://emailpilot-orchestrator-p3cxgvcsla-uc.a.run.app' : 'http://localhost:8001';
            window.EMAILPILOT_ORCHESTRATOR_URL = orchestratorUrl;

            const authScript = document.createElement('script');
            authScript.src = `${orchestratorUrl}/static/js/auth_controller.js?v=20251215-dynamic`;
            document.head.appendChild(authScript);

            const impScript = document.createElement('script');
            impScript.src = `${orchestratorUrl}/static/js/impersonation.js?v=20251215`;
            impScript.defer = true;
            document.head.appendChild(impScript);
        })();
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .status-processing {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }
    </style>
    <!-- EP:UI-SHELL:START -->
    <script>
        (function () {
            if (window.__EP_UI_SHELL_INCLUDE__) return;
            window.__EP_UI_SHELL_INCLUDE__ = true;

            const enabled = window.__EP_ENABLE_SHELL__ === true ||
                document.documentElement.hasAttribute('data-ep-shell') ||
                document.body?.hasAttribute('data-ep-shell');

            const host = window.location.hostname;
            const isLocal = host === 'localhost' || host === '127.0.0.1';
            const base = isLocal ? 'http://localhost:8001/static' : 'https://app.emailpilot.ai/static';
            const version = '20260131';

            window.__EP_UI_SHELL_BASE__ = base;
            window.__EP_UI_SHELL_VERSION__ = version;

            const head = document.head || document.getElementsByTagName('head')[0];
            if (!head) return;

            const ensureFavicon = (rel, href, type, sizes) => {
                if (document.querySelector(`link[rel="${rel}"][href="${href}"]`)) return;
                const link = document.createElement('link');
                link.rel = rel;
                link.href = href;
                if (type) link.type = type;
                if (sizes) link.sizes = sizes;
                link.setAttribute('data-ep-favicon', 'true');
                head.appendChild(link);
            };

            ensureFavicon('icon', `${base}/assets/favicon.ico`, 'image/x-icon');
            ensureFavicon('icon', `${base}/assets/favicon-32x32.png`, 'image/png', '32x32');
            ensureFavicon('icon', `${base}/assets/favicon-16x16.png`, 'image/png', '16x16');

            if (!enabled) return;

            const hasScript = (match) => Array.from(document.scripts || []).some((script) => script.src && script.src.includes(match));
            const ensureScript = (src, key) => {
                if (document.querySelector(`script[data-ep-shell-lib="${key}"]`) || hasScript(src)) return;
                const script = document.createElement('script');
                script.src = src;
                script.setAttribute('data-ep-shell-lib', key);
                head.appendChild(script);
            };
            const ensureStylesheet = (href) => {
                if (document.querySelector(`link[data-ep-shell-css]`) || Array.from(document.querySelectorAll('link[rel="stylesheet"]')).some((link) => link.href && link.href.includes('ui-shell'))) return;
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;
                link.setAttribute('data-ep-shell-css', 'true');
                head.appendChild(link);
            };

            ensureScript('https://cdn.tailwindcss.com', 'tailwind');
            ensureScript('https://unpkg.com/lucide@latest', 'lucide');
            ensureScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js', 'gsap');
            ensureStylesheet(`${base}/ui-shell.v${version}.css?cb=20260131b`);
            ensureScript(`${base}/ui-shell.v${version}.js?cb=20260131b`, 'ui-shell');
        })();
    </script>
    <!-- EP:UI-SHELL:END -->
</head>

<body class="h-screen flex overflow-hidden ep-shell-lock" data-layout="ultimate">
    <div class="gradient-bg fixed inset-0 z-[-1] opacity-5"></div>

    <!-- Sidebar injected by ui-shell.js from orchestrator -->

    <div class="main-container" data-ui="main-container">
        <div class="content-scroll" data-ui="content-scroll">
            <div class="top-header" data-ui="top-header">
                <div class="header-left">
                    <h1 class="text-5xl font-black text-gray-900 mb-4 font-display tracking-tight leading-none">
                        Intelligence Hub</h1>
                    <p class="text-[11px] font-black uppercase tracking-[0.3em] text-gray-400">Intelligence Operations
                    </p>
                    <p class="text-lg text-gray-500 font-medium mt-2">Centralized knowledge base for strategy, assets, and client intelligence.</p>
                </div>
                <div class="header-actions flex items-center gap-8" data-ui="header-actions">
                    <div class="search-bar bg-white/80 border border-gray-200 rounded-2xl px-6 py-4 flex items-center gap-4 shadow-sm transition-all duration-500 focus-within:ring-4 focus-within:ring-blue-500/5 focus-within:border-blue-200"
                        data-ui="search">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                        <input type="text" placeholder="Search documents, embeddings, collections..."
                            aria-label="Search documents, embeddings, collections..."
                            class="bg-transparent border-none outline-none text-base w-full text-gray-700 font-medium placeholder:text-gray-400">
                    </div>
                </div>
            </div>
            <!-- Navigation Header -->
            <nav class="bg-white border-b border-gray-200 px-4 py-3">
                <div class="max-w-7xl mx-auto flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <h1 class="text-lg font-semibold text-gray-900">Intelligence Tools</h1>
                        <div class="flex items-center space-x-4">
                            <a href="/ui/" class="text-sm font-medium text-gray-600 hover:text-indigo-600 transition-colors flex items-center gap-1.5">
                                Document Manager
                            </a>
                            <a href="/ui/image-repository.html"
                                class="text-sm font-medium text-gray-600 hover:text-pink-600 transition-colors flex items-center gap-1.5">
                                <i data-lucide="image" class="w-4 h-4"></i>
                                Visual Intelligence
                            </a>
                            <a href="/ui/meeting-intelligence.html"
                                class="text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                Meeting Intelligence
                            </a>
                            <a href="/ui/email-repository.html"
                                class="text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors flex items-center gap-1.5">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                                Email Intelligence
                            </a>
                            <a href="/ui/email-review.html"
                                class="text-sm font-medium text-gray-600 hover:text-orange-600 transition-colors flex items-center gap-1.5">
                                <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                                Email Review
                            </a>
                            <a href="/ui/figma-feedback.html"
                                class="text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 pb-1 flex items-center gap-1.5">
                                <i data-lucide="message-square" class="w-4 h-4"></i>
                                Figma Feedback
                            </a>
                        </div>
                    </div>
                    <div id="shell-auth-chip"></div>
                </div>
            </nav>
            <script>
                (function () {
                    async function setupAuth() {
                        if (typeof EmailPilotAuth === 'undefined') {
                            setTimeout(setupAuth, 100);
                            return;
                        }
                        await EmailPilotAuth.ready();
                        EmailPilotAuth.subscribe((user) => {
                            const chip = document.getElementById('shell-auth-chip');
                            if (user && chip) {
                                chip.innerHTML = `
                            <div class="flex items-center space-x-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-xs font-medium text-gray-700">${user.email}</span>
                            </div>
                        `;
                            }
                        });
                    }
                    setupAuth();
                })();
            </script>
            <script>lucide.createIcons();</script>

        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-6xl mx-auto">
                <!-- Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="ep-card ep-shadow-none bg-white p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Total
                                Rules</span>
                            <div class="p-2 bg-indigo-50 rounded-lg"><i data-lucide="shield-check"
                                    class="w-5 h-5 text-indigo-600"></i></div>
                        </div>
                        <div class="text-3xl font-black text-gray-900" id="stat-total-rules">-</div>
                        <p class="text-xs text-gray-400 mt-1">Creative constraints extracted</p>
                    </div>
                    <div class="ep-card ep-shadow-none bg-white p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Negative
                                Constraints</span>
                            <div class="p-2 bg-red-50 rounded-lg"><i data-lucide="alert-triangle"
                                    class="w-5 h-5 text-red-600"></i></div>
                        </div>
                        <div class="text-3xl font-black text-gray-900" id="stat-neg-rules">-</div>
                        <p class="text-xs text-gray-400 mt-1">Mistakes to avoid repeating</p>
                    </div>
                    <div class="ep-card ep-shadow-none bg-white p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Last
                                Processed</span>
                            <div class="p-2 bg-green-50 rounded-lg"><i data-lucide="clock"
                                    class="w-5 h-5 text-green-600"></i></div>
                        </div>
                        <div class="text-xl font-bold text-gray-900" id="stat-last-processed">Never</div>
                        <p class="text-xs text-gray-400 mt-1">Automatic nightly sync</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="ep-card ep-shadow-none bg-white p-6 mb-8">
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Select
                                Brand</label>
                            <select id="client-selector"
                                class="w-full bg-gray-50 border-gray-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all">
                                <option value="">Loading brands...</option>
                            </select>
                        </div>
                        <div>
                            <button id="run-pipeline-btn" onclick="runPipeline()"
                                class="ep-btn-primary flex items-center gap-2 disabled:opacity-50">
                                <i data-lucide="play" class="w-4 h-4"></i>
                                <span>Process New Feedback</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Rules List -->
                <div class="ep-card ep-shadow-none bg-white overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-50 flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-900">Creative Guardrails (Intelligence Hub)</h2>
                        <div class="flex gap-2">
                            <button onclick="loadRules()" class="p-2 hover:bg-gray-50 rounded-lg transition-colors"><i
                                    data-lucide="refresh-cw" class="w-4 h-4 text-gray-400"></i></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50/50">
                                    <th
                                        class="px-6 py-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                        Rule</th>
                                    <th
                                        class="px-6 py-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                        Category</th>
                                    <th
                                        class="px-6 py-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                        Sentiment</th>
                                    <th
                                        class="px-6 py-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                        Ingested</th>
                                </tr>
                            </thead>
                            <tbody id="rules-table-body" class="divide-y divide-gray-50">
                                <tr>
                                    <td colspan="4" class="px-6 py-12 text-center text-gray-400 italic">
                                        Select a brand to view creative rules
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-8 right-8 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl translate-y-20 transition-all duration-500 flex items-center gap-3 z-50">
        <span id="toast-message">Message</span>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedClientId = '';

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.classList.remove('translate-y-20');
            setTimeout(() => toast.classList.add('translate-y-20'), 3000);
        }

        async function loadClients() {
            try {
                const res = await fetch(`${API_BASE}/api/orchestrator/clients`, { credentials: 'include' });
                const data = await res.json();
                const selector = document.getElementById('client-selector');

                selector.innerHTML = '<option value="">-- Choose a Brand --</option>';
                data.clients.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.client_id;
                    opt.textContent = c.name;
                    selector.appendChild(opt);
                });

                selector.addEventListener('change', (e) => {
                    selectedClientId = e.target.value;
                    if (selectedClientId) loadRules();
                });
            } catch (e) {
                console.error('Failed to load clients', e);
            }
        }

        async function loadRules() {
            if (!selectedClientId) return;

            const tbody = document.getElementById('rules-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center"><div class="animate-spin w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full mx-auto"></div></td></tr>';

            try {
                const res = await fetch(`${API_BASE}/api/figma-feedback/rules/${selectedClientId}`, { credentials: 'include' });
                const data = await res.json();

                if (!data.rules || data.rules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-400">No creative rules found for this brand yet.</td></tr>';
                    updateStats(0, 0);
                    return;
                }

                let negCount = 0;
                tbody.innerHTML = data.rules.map(r => {
                    if (r.sentiment === 'negative') negCount++;
                    const sentimentClass = r.sentiment === 'negative' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600';
                    const categoryClass = 'bg-gray-100 text-gray-600';

                    return `
                        <tr class="hover:bg-gray-50/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-900 text-sm">${r.rule}</div>
                                <div class="text-[10px] text-gray-400 mt-1 font-mono">${r.source_file}</div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wider ${categoryClass}">${r.category}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wider ${sentimentClass}">${r.sentiment}</span>
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-500 font-medium">
                                ${new Date(r.ingested_at).toLocaleDateString()}
                            </td>
                        </tr>
                    `;
                }).join('');

                updateStats(data.rules.length, negCount);
                if (data.rules.length > 0) {
                    document.getElementById('stat-last-processed').textContent = new Date(data.rules[0].ingested_at).toLocaleTimeString();
                }

            } catch (e) {
                console.error('Failed to load rules', e);
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-red-500 font-bold">Failed to load rules. Check BigQuery connectivity.</td></tr>';
            }
        }

        function updateStats(total, neg) {
            document.getElementById('stat-total-rules').textContent = total;
            document.getElementById('stat-neg-rules').textContent = neg;
        }

        async function runPipeline() {
            if (!selectedClientId) {
                showToast('Please select a brand first');
                return;
            }

            const btn = document.getElementById('run-pipeline-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span>Processing...</span>';

            try {
                const res = await fetch(`${API_BASE}/api/figma-feedback/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: selectedClientId, lookback_hours: 24 }),
                    credentials: 'include'
                });

                const data = await res.json();
                if (data.success) {
                    showToast('Processing started in background');
                    setTimeout(loadRules, 5000); // Wait 5s then refresh
                } else {
                    showToast('Failed to start processing: ' + data.message, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i><span>Process New Feedback</span>';
                lucide.createIcons();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadClients();
        });
    </script>
</body>

</html>
